Description:
  This template deploys network resources for Kubernetess cluster.


Parameters:
  TemplateName:
    Description: A stack's name
    Type: String

  VpcCIDR:
    Description: IP range (CIDR notation) for VPC
    Type: String

  PubSub1CIDR:
    Description: CIDR block for NAT gateway in public subnet
    Type: String

  PubSub2CIDR:
    Description: CIDR block for NAT gateway in public subnet
    Type: String

  PriSubWorker1CIDR:
    Description: CIDR block for worker nodes in private subnet
    Type: String

  PriSubWorker2CIDR:
    Description: CIDR block for worker nodes in private subnet
    Type: String

  PriSubMasterCIDR:
    Description: CIDR block for master node private subnet
    Type: String


Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Ref TemplateName

  PubSub1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: ap-northeast-2b
      CidrBlock: !Ref PubSub1CIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub PublicSubnet1 for ${TemplateName}

  PubSub2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: ap-northeast-2c
      CidrBlock: !Ref PubSub2CIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub PublicSubnet2 for ${TemplateName}

  PriSubWorker1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: ap-northeast-2b
      CidrBlock: !Ref PriSubWorker1CIDR
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub PrivateSubnet1 for workers in ${TemplateName}

  PriSubWorker2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: ap-northeast-2c
      CidrBlock: !Ref PriSubWorker2CIDR
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub PrivateSubnet2 for workers in ${TemplateName}

  PriSubMaster:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: ap-northeast-2a
      CidrBlock: !Ref PriSubMasterCIDR
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub PrivateSubnet for master in ${TemplateName}

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Ref TemplateName

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  ElasticIPforNATGateway1:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub EIP for NAT in PublicSubnet1

  NATGateway1:
    Type: AWS::EC2::NatGateway
    DependsOn: ElasticIPforNATGateway1
    Properties:
      AllocationId: !GetAtt ElasticIPforNATGateway1.AllocationId
      SubnetId: !Ref PubSub1
      Tags:
        - Key: Name
          Value: !Sub NatGateway in PublicSubnet1

  ElasticIPforNATGateway2:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub EIP for NAT in PublicSubnet2

  NATGateway2:
    Type: AWS::EC2::NatGateway
    DependsOn: ElasticIPforNATGateway2
    Properties:
      AllocationId: !GetAtt ElasticIPforNATGateway2.AllocationId
      SubnetId: !Ref PubSub2
      Tags:
        - Key: Name
          Value: !Sub NatGateway in PublicSubnet2
